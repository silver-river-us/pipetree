{% extends "base.html" %}

{% block title %}{{ benchmark.name if benchmark else 'Benchmark' }} - Pipetree Visualizer{% endblock %}

{% block head %}
<!-- ApexCharts -->
<script src="/static/vendor/js/apexcharts.min.js"></script>
{% endblock %}

{% block content %}
<div class="px-6 py-4">
    <!-- Breadcrumb -->
    <nav class="flex mb-4" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-2">
            <li class="inline-flex items-center">
                <a href="/benchmarks" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Benchmarks
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-1.5">{{ benchmark.name if benchmark else benchmark_id[:8] }}</span>
                </div>
            </li>
        </ol>
    </nav>

    {% if benchmark %}
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ benchmark.name or 'Benchmark' }}</h1>
        {% if benchmark.description %}
        <p class="text-gray-600 mt-1">{{ benchmark.description }}</p>
        {% endif %}
    </div>
    {% else %}
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Benchmark Not Found</h1>
    </div>
    {% endif %}

    {% if benchmark %}
    <!-- Benchmark Info -->
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div>
                <p class="text-xs text-gray-500 uppercase">Capability</p>
                <p class="text-sm font-medium mt-2">
                    <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded">{{ benchmark.capability }}</span>
                </p>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase">Implementations</p>
                <p class="text-sm font-medium mt-2">{{ implementations | length }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase">Results</p>
                <p class="text-sm font-medium mt-2"><span id="result-count">{{ results | length }}</span></p>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase">Status</p>
                <p class="text-sm font-medium mt-2">
                    {% if benchmark.status == 'completed' %}
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded">Completed</span>
                    {% elif benchmark.status == 'running' %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded">
                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Running
                    </span>
                    <span class="ml-2 text-xs text-gray-500">(auto-refreshes on completion)</span>
                    {% else %}
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded">{{ benchmark.status }}</span>
                    {% endif %}
                </p>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase">Created</p>
                <p class="text-sm font-medium">
                    {% if benchmark.created_at %}
                    {{ benchmark.created_at | int | format_timestamp }}
                    {% else %}
                    -
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Implementation Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-{{ [implementations | length, 4] | min }} gap-4 mb-6">
        {% for impl in implementations %}
        {% set impl_summary = summary.get(impl, {}) %}
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3 truncate" title="{{ impl }}">{{ impl }}</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-500">Avg Time</span>
                    <span class="font-medium">{{ "%.3f" | format(impl_summary.avg_wall_time_s or 0) }}s</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Avg CPU Time</span>
                    <span class="font-medium">{{ "%.3f" | format(impl_summary.avg_cpu_time_s or 0) }}s</span>
                </div>
                {% if impl_summary.avg_cpu_time_s and impl_summary.avg_wall_time_s and impl_summary.avg_wall_time_s > 0 %}
                {% set cpu_pct = (impl_summary.avg_cpu_time_s / impl_summary.avg_wall_time_s) * 100 %}
                <div class="flex justify-between">
                    <span class="text-gray-500">Avg CPU %</span>
                    <span class="font-medium">{% if cpu_pct < 1 %}{{ "%.2f" | format(cpu_pct) }}{% else %}{{ "%.1f" | format(cpu_pct) }}{% endif %}%</span>
                </div>
                {% endif %}
                <div class="flex justify-between">
                    <span class="text-gray-500">Avg Memory</span>
                    <span class="font-medium">{{ "%.1f" | format(impl_summary.avg_peak_mem_mb or 0) }} MB</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Correctness</span>
                    <span class="font-medium">{{ "%.0f" | format((impl_summary.avg_correctness or 0) * 100) }}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Fixtures</span>
                    <span class="font-medium">{{ impl_summary.fixture_count or 0 }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Execution Time Chart -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Execution Time by Fixture</h3>
            <div id="chart-time" class="h-80"></div>
        </div>

        <!-- Memory Usage Chart -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Peak Memory by Fixture</h3>
            <div id="chart-memory" class="h-80"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- CPU Time Chart -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">CPU Time by Fixture</h3>
            <div id="chart-cpu" class="h-80"></div>
        </div>

        <!-- CPU Utilization Chart -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">CPU Utilization % by Fixture</h3>
            <div id="chart-cpu-percent" class="h-80"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Correctness Chart -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Correctness by Fixture</h3>
            <div id="chart-correctness" class="h-80"></div>
        </div>

        <!-- Summary Comparison -->
        <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Overall Comparison</h3>
            <div id="chart-summary" class="h-80"></div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Detailed Results</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fixture</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Implementation</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wall Time</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CPU Time</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CPU %</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Peak Memory</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Correctness</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for result in results %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ result.fixture_id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ result.impl_name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if result.wall_time_s %}
                            {{ "%.3f" | format(result.wall_time_s) }}s
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if result.cpu_time_s %}
                            {{ "%.3f" | format(result.cpu_time_s) }}s
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if result.cpu_time_s and result.wall_time_s and result.wall_time_s > 0 %}
                            {% set cpu_pct = (result.cpu_time_s / result.wall_time_s) * 100 %}
                            {% if cpu_pct < 1 %}{{ "%.2f" | format(cpu_pct) }}{% else %}{{ "%.1f" | format(cpu_pct) }}{% endif %}%
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if result.peak_mem_mb %}
                            {{ "%.1f" | format(result.peak_mem_mb) }} MB
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if result.correctness is not none %}
                            {{ "%.0f" | format(result.correctness * 100) }}%
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ result.items_processed or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if result.error %}
                            <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded" title="{{ result.error }}">Error</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">OK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <!-- Not Found -->
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg p-12 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="mt-4 text-lg font-semibold text-gray-900">Benchmark Not Found</h3>
        <p class="mt-2 text-gray-600">The requested benchmark could not be found in the database.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if benchmark %}
<script>
    const benchmarkId = "{{ benchmark_id }}";
    const dbPath = "{{ db_path }}";
    const initialStatus = "{{ benchmark.status }}";
</script>
<script src="/static/js/benchmarks.js"></script>
{% if benchmark.status == 'running' %}
<script>
// WebSocket for real-time benchmark updates
(function() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/benchmark/${benchmarkId}?db=${encodeURIComponent(dbPath)}`;

    console.log('Connecting to WebSocket:', wsUrl);

    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connect() {
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            console.log('WebSocket connected for benchmark:', benchmarkId);
            reconnectAttempts = 0;
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('WebSocket message:', data);

            if (data.type === 'update') {
                // Update result count display
                const resultCountEl = document.getElementById('result-count');
                if (resultCountEl && data.result_count !== undefined) {
                    resultCountEl.textContent = data.result_count;
                }

                // Update status badge if status changed
                if (data.status && data.status !== 'running') {
                    console.log('Status changed to:', data.status);
                }
            }

            if (data.type === 'complete') {
                console.log('Benchmark completed:', data.status);
                ws.close();
                // Small delay to ensure WebSocket closes cleanly
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }

            if (data.type === 'error') {
                console.error('WebSocket error from server:', data.message);
            }
        };

        ws.onclose = function(event) {
            console.log('WebSocket closed:', event.code, event.reason);
            // Only reconnect if it wasn't a clean close
            if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log('Reconnecting... attempt', reconnectAttempts);
                setTimeout(connect, 2000);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket connection error:', error);
        };
    }

    connect();

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close(1000, 'Page unload');
        }
    });
})();
</script>
{% endif %}
{% endif %}
{% endblock %}
