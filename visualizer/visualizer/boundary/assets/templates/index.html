{% extends "base.html" %}

{% block title %}Dashboard - Pipetree Visualizer{% endblock %}

{% block content %}
<div class="p-6 max-w-screen-xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Runs</h1>
            <p class="text-gray-600 text-sm">{{ total_count }} total runs</p>
        </div>
        <div id="compare-section" class="flex items-center gap-3">
            <span id="selection-info" class="text-sm text-gray-500 hidden"></span>
            <button id="compare-btn"
                    onclick="compareRuns()"
                    disabled
                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Compare
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 shadow-sm p-3 mb-4 rounded-lg">
        <form id="filter-form" class="flex flex-wrap items-center gap-3">
            <!-- Hidden page input for HTMX requests -->
            <input type="hidden" id="page-input" name="page" value="{{ page }}">

            <!-- Status filter -->
            <div class="flex items-center gap-2">
                <label for="status-filter" class="text-sm font-medium text-gray-600">Status:</label>
                <select id="status-filter" name="status" class="px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="">All</option>
                    <option value="running" {% if current_status == 'running' %}selected{% endif %}>Running</option>
                    <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>Failed</option>
                    <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                </select>
            </div>

            <!-- Pipeline filter -->
            <div class="flex items-center gap-2">
                <label for="pipeline-filter" class="text-sm font-medium text-gray-600">Pipeline:</label>
                <select id="pipeline-filter" name="pipeline" class="px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 min-w-[150px]">
                    <option value="">All pipelines</option>
                    {% for name in pipeline_names %}
                    <option value="{{ name }}" {% if current_pipeline == name %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Page size -->
            <div class="flex items-center gap-2">
                <label for="per-page" class="text-sm font-medium text-gray-600">Show:</label>
                <select id="per-page" name="per_page" class="px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>

            <!-- Clear filters -->
            {% if current_status or current_pipeline %}
            <a href="/" class="text-sm text-blue-600 hover:text-blue-800">Clear filters</a>
            {% endif %}
        </form>
    </div>

    <!-- Runs list -->
    <div id="runs-list"
         hx-get="/api/runs"
         hx-trigger="every 2s"
         hx-include="#filter-form"
         hx-swap="innerHTML">
        {% include "partials/runs_list.html" %}
    </div>
</div>

<script>
// Run comparison logic
let selectedRuns = [];

function updateCompareButton() {
    const checkboxes = document.querySelectorAll('.run-checkbox:checked');
    selectedRuns = Array.from(checkboxes).map(cb => ({
        id: cb.dataset.runId,
        pipeline: cb.dataset.pipeline,
        dbPath: cb.dataset.dbPath
    }));

    const btn = document.getElementById('compare-btn');
    const info = document.getElementById('selection-info');

    if (selectedRuns.length === 0) {
        btn.disabled = true;
        info.classList.add('hidden');
        info.textContent = '';
    } else if (selectedRuns.length === 1) {
        btn.disabled = true;
        info.classList.remove('hidden');
        info.textContent = '1 run selected (select 2 to compare)';
    } else if (selectedRuns.length === 2) {
        const samePipeline = selectedRuns[0].pipeline === selectedRuns[1].pipeline;
        if (samePipeline) {
            btn.disabled = false;
            info.classList.remove('hidden');
            info.textContent = '2 runs selected';
        } else {
            btn.disabled = true;
            info.classList.remove('hidden');
            info.textContent = 'Runs must be from the same pipeline';
            info.classList.add('text-red-500');
            info.classList.remove('text-gray-500');
        }
    } else {
        btn.disabled = true;
        info.classList.remove('hidden');
        info.textContent = `${selectedRuns.length} selected (select exactly 2)`;
    }

    // Reset text color
    if (selectedRuns.length !== 2 || selectedRuns[0].pipeline === selectedRuns[1].pipeline) {
        info.classList.remove('text-red-500');
        info.classList.add('text-gray-500');
    }
}

function compareRuns() {
    if (selectedRuns.length !== 2) return;
    if (selectedRuns[0].pipeline !== selectedRuns[1].pipeline) return;

    const run1 = selectedRuns[0];
    const run2 = selectedRuns[1];
    const url = `/compare?run1=${run1.id}&db1=${encodeURIComponent(run1.dbPath)}&run2=${run2.id}&db2=${encodeURIComponent(run2.dbPath)}`;
    window.location.href = url;
}

// Preserve checkbox state after HTMX refresh
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'runs-list') {
        // Re-check previously selected runs
        selectedRuns.forEach(run => {
            const checkbox = document.querySelector(`.run-checkbox[data-run-id="${run.id}"]`);
            if (checkbox) checkbox.checked = true;
        });
        updateCompareButton();
    }
});

// Auto-submit filters on change (reset to page 1)
function applyFilters() {
    const form = document.getElementById('filter-form');
    const params = new URLSearchParams(new FormData(form));
    // Reset to page 1 when filters change
    params.delete('page');
    // Filter out empty values
    for (const [key, value] of [...params.entries()]) {
        if (!value) params.delete(key);
    }
    window.location.href = '/?' + params.toString();
}

document.getElementById('status-filter').addEventListener('change', applyFilters);
document.getElementById('pipeline-filter').addEventListener('change', applyFilters);
document.getElementById('per-page').addEventListener('change', applyFilters);

// Delete run
async function deleteRun(id, dbPath) {
    if (!confirm('Are you sure you want to delete this run? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/runs/${id}?db=${encodeURIComponent(dbPath)}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
            // Trigger HTMX refresh
            htmx.trigger('#runs-list', 'htmx:trigger');
        } else {
            alert('Failed to delete run: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to delete run: ' + error.message);
    }
}
</script>
{% endblock %}
