{% if run %}
{% include "partials/steps_data.html" %}

<!-- SVG Tree View (shown for horizontal/vertical layouts) -->
<div class="tree-container bg-white border border-gray-200 shadow-sm" id="tree-view">
    <svg id="tree-svg"></svg>
</div>

<!-- List View (shown for list layout) -->
<div class="list-view hidden bg-white border border-gray-200 shadow-sm"
     id="list-view"
     hx-get="/runs/{{ run.id }}/steps/list?db={{ db_path }}"
     hx-trigger="steps:update"
     hx-swap="innerHTML">
    {% include "partials/step_list.html" %}
</div>

<script type="module">
import { PipetreeViz } from '/static/js/pipetree/index.js';

const btnH = document.getElementById('btn-h');
const btnV = document.getElementById('btn-v');
const btnList = document.getElementById('btn-list');
const treeView = document.getElementById('tree-view');
const listView = document.getElementById('list-view');

function updateButtonStates(layout) {
    btnH.classList.toggle('active', layout === 'horizontal');
    btnV.classList.toggle('active', layout === 'vertical');
    btnList.classList.toggle('active', layout === 'list');

    // Toggle views
    if (layout === 'list') {
        treeView.classList.add('hidden');
        listView.classList.remove('hidden');
    } else {
        treeView.classList.remove('hidden');
        listView.classList.add('hidden');
    }
}

// Initialize the pipetree visualization
const viz = new PipetreeViz({
    svgSelector: '#tree-svg',
    dataSelector: '#steps-data',
    containerSelector: '.tree-container',
    onNodeClick: function(runId, stepIndex, dbPath) {
        openStepModal(runId, stepIndex, dbPath);
    }
}).init();

// Expose globally for debugging
window.pipetreeViz = viz;

// Set up button handlers
btnH.addEventListener('click', () => {
    viz.setLayout('horizontal');
    updateButtonStates('horizontal');
});

btnV.addEventListener('click', () => {
    viz.setLayout('vertical');
    updateButtonStates('vertical');
});

btnList.addEventListener('click', () => {
    viz.setLayout('list');
    updateButtonStates('list');
});

// Set initial button states and view
updateButtonStates(viz.layout);
</script>
{% else %}
<p class="text-gray-500">No step information available.</p>
{% endif %}
