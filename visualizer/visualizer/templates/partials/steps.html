{% if run %}
<div data-run-status="{{ run.status }}">
    {% include "partials/steps_data.html" %}
    <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold text-gray-900">Steps</h2>
        <div class="tree-controls">
            <button id="btn-h">Horizontal</button>
            <button id="btn-v">Vertical</button>
        </div>
    </div>

    <div class="tree-container">
        <svg id="tree-svg"></svg>
    </div>

    <script type="module">
    import { PipetreeViz } from '/static/js/pipetree/index.js';

    const btnH = document.getElementById('btn-h');
    const btnV = document.getElementById('btn-v');

    function updateButtonStates(layout) {
        btnH.classList.toggle('active', layout === 'horizontal');
        btnV.classList.toggle('active', layout === 'vertical');
    }

    // Initialize the pipetree visualization
    const viz = new PipetreeViz({
        svgSelector: '#tree-svg',
        dataSelector: '#steps-data',
        containerSelector: '.tree-container',
        onNodeClick: function(runId, stepIndex, dbPath) {
            openStepModal(runId, stepIndex, dbPath);
        }
    }).init();

    // Expose globally for debugging
    window.pipetreeViz = viz;

    // Set up button handlers
    btnH.addEventListener('click', () => {
        viz.setLayout('horizontal');
        updateButtonStates('horizontal');
    });

    btnV.addEventListener('click', () => {
        viz.setLayout('vertical');
        updateButtonStates('vertical');
    });

    // Set initial button states
    updateButtonStates(viz.layout);
    </script>

    <!-- Step list -->
    <div class="mt-4 border-t border-gray-200 pt-4"
         id="step-list"
         hx-get="/runs/{{ run.id }}/steps/list?db={{ db_path }}"
         hx-trigger="steps:update"
         hx-swap="innerHTML">
        {% include "partials/step_list.html" %}
    </div>
</div>
{% else %}
<p class="text-gray-500">No step information available.</p>
{% endif %}
