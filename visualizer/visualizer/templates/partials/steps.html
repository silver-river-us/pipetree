{% if run %}
{% include "partials/steps_data.html" %}

<!-- Current Step Status Bar (shown when a step is running) -->
{% set running_step = steps | selectattr('status', 'equalto', 'running') | first %}
<div id="current-step-bar"
     class="{% if not running_step %}hidden{% endif %} bg-blue-50 border border-blue-200 px-4 py-3 mb-4 rounded-lg flex items-center gap-3">
    <div class="flex items-center gap-2 text-blue-700">
        <svg class="w-5 h-5 animate-spin flex-shrink-0" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="font-semibold">Running:</span>
    </div>
    <div class="flex items-center gap-2 flex-1 min-w-0">
        <span id="current-step-name" class="font-medium text-gray-900">{{ running_step.name if running_step else '' }}</span>
        <span id="current-step-progress" class="text-blue-600"
              {% if running_step %}
              data-step-index="{{ running_step.step_index }}"
              hx-get="/runs/{{ run.id }}/step/{{ running_step.step_index }}/summary?db={{ db_path }}"
              hx-trigger="load"
              hx-swap="innerHTML"
              {% endif %}>
        </span>
    </div>
</div>

<!-- SVG Tree View (shown for horizontal/vertical layouts) -->
<div class="tree-container bg-white border border-gray-200 shadow-sm" id="tree-view">
    <svg id="tree-svg"></svg>
</div>

<!-- List View (shown for list layout) -->
<div class="list-view hidden bg-white border border-gray-200 shadow-sm"
     id="list-view"
     hx-get="/runs/{{ run.id }}/steps/list?db={{ db_path }}"
     hx-trigger="steps:update"
     hx-swap="innerHTML">
    {% include "partials/step_list.html" %}
</div>

<script type="module">
import { PipetreeViz } from '/static/js/pipetree/index.js';

const btnH = document.getElementById('btn-h');
const btnV = document.getElementById('btn-v');
const btnList = document.getElementById('btn-list');
const treeView = document.getElementById('tree-view');
const listView = document.getElementById('list-view');

function updateButtonStates(layout) {
    btnH.classList.toggle('active', layout === 'horizontal');
    btnV.classList.toggle('active', layout === 'vertical');
    btnList.classList.toggle('active', layout === 'list');

    // Toggle views
    if (layout === 'list') {
        treeView.classList.add('hidden');
        listView.classList.remove('hidden');
    } else {
        treeView.classList.remove('hidden');
        listView.classList.add('hidden');
    }
}

// Initialize the pipetree visualization
const viz = new PipetreeViz({
    svgSelector: '#tree-svg',
    dataSelector: '#steps-data',
    containerSelector: '.tree-container',
    onNodeClick: function(runId, stepIndex, dbPath) {
        openStepModal(runId, stepIndex, dbPath);
    }
}).init();

// Expose globally for debugging
window.pipetreeViz = viz;

// Set up button handlers
btnH.addEventListener('click', () => {
    viz.setLayout('horizontal');
    updateButtonStates('horizontal');
});

btnV.addEventListener('click', () => {
    viz.setLayout('vertical');
    updateButtonStates('vertical');
});

btnList.addEventListener('click', () => {
    viz.setLayout('list');
    updateButtonStates('list');
});

// Set initial button states and view
updateButtonStates(viz.layout);
</script>
{% else %}
<p class="text-gray-500">No step information available.</p>
{% endif %}
