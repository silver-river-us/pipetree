{% if run %}
<div data-run-status="{{ run.status }}">
    {% include "partials/steps_data.html" %}
    <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold text-gray-900">Steps</h2>
        <div class="tree-controls">
            <button id="btn-h" onclick="pipetreeViz.setLayout('horizontal')">Horizontal</button>
            <button id="btn-v" onclick="pipetreeViz.setLayout('vertical')">Vertical</button>
        </div>
    </div>

    <div class="tree-container">
        <svg id="tree-svg"></svg>
    </div>

    <script src="/static/js/pipetree.js"></script>
    <script>
    (function() {
        // Initialize the pipetree visualization
        window.pipetreeViz = new PipetreeViz({
            svgSelector: '#tree-svg',
            dataSelector: '#steps-data',
            containerSelector: '.tree-container',
            onNodeClick: function(runId, stepIndex, dbPath) {
                openStepModal(runId, stepIndex, dbPath);
            }
        }).init();

        // Update button states
        var layout = localStorage.getItem('pipetreeLayout') || 'vertical';
        document.getElementById('btn-h').classList.toggle('active', layout === 'horizontal');
        document.getElementById('btn-v').classList.toggle('active', layout === 'vertical');
    })();
    </script>

    <!-- Step list -->
    <div class="mt-4 border-t border-gray-200 pt-4"
         id="step-list"
         hx-get="/runs/{{ run.id }}/steps/list?db={{ db_path }}"
         hx-trigger="steps:update"
         hx-swap="innerHTML">
        {% include "partials/step_list.html" %}
    </div>
</div>
{% else %}
<p class="text-gray-500">No step information available.</p>
{% endif %}
