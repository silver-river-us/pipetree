{% extends "base.html" %}

{% block title %}Benchmarks - Pipetree Visualizer{% endblock %}

{% block content %}
<div class="p-6 max-w-screen-2xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Benchmarks</h1>
            <p class="text-gray-600 text-sm">{{ total_count }} total benchmark{{ 's' if total_count != 1 else '' }}</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white border border-gray-200 shadow-sm p-3 mb-4 rounded-lg">
        <form id="filter-form" class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-2">
                <label for="per-page" class="text-sm font-medium text-gray-600">Show:</label>
                <select id="per-page" name="per_page" class="px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </form>
    </div>

    {% if benchmarks %}
    <!-- Benchmarks List -->
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capability</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Implementations</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Database</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for benchmark in benchmarks %}
                <tr class="hover:bg-gray-50" id="benchmark-row-{{ benchmark.id }}">
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        <div class="text-sm font-medium text-blue-600 hover:text-blue-800">
                            {{ benchmark.name or benchmark.id[:8] }}
                        </div>
                        {% if benchmark.description %}
                        <div class="text-xs text-gray-500">{{ benchmark.description }}</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">
                            {{ benchmark.capability }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        {{ benchmark.impl_count }} implementation{{ 's' if benchmark.impl_count != 1 else '' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        {% if benchmark.status == 'completed' %}
                        <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">Completed</span>
                        {% elif benchmark.status == 'running' %}
                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">Running</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">{{ benchmark.status }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        {{ benchmark.db_name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 cursor-pointer" onclick="window.location.href='/benchmarks/{{ benchmark.id }}?db={{ benchmark.db_path }}'">
                        {% if benchmark.created_at %}
                        <span data-timestamp="{{ benchmark.created_at }}">
                            {{ benchmark.created_at | int | format_timestamp }}
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button onclick="deleteBenchmark('{{ benchmark.id }}', '{{ benchmark.db_path }}')"
                                class="text-red-600 hover:text-red-800 text-sm font-medium">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    {% set base_params %}{% if per_page != 10 %}&per_page={{ per_page }}{% endif %}{% endset %}
    <div class="flex items-center justify-between mt-4 px-1">
        <div class="text-sm text-gray-600">
            Showing {{ ((page - 1) * per_page) + 1 }}-{{ [page * per_page, total_count] | min }} of {{ total_count }}
        </div>
        <div class="flex items-center gap-1">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}{{ base_params }}"
               class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                Previous
            </a>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <span class="px-3 py-1 text-sm bg-blue-600 text-white rounded">{{ p }}</span>
                {% elif p == 1 or p == total_pages or (p >= page - 1 and p <= page + 1) %}
                <a href="?page={{ p }}{{ base_params }}"
                   class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                    {{ p }}
                </a>
                {% elif p == page - 2 or p == page + 2 %}
                <span class="px-2 text-gray-400">...</span>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}{{ base_params }}"
               class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                Next
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="bg-white border border-gray-200 shadow-sm rounded-lg py-32 text-center">
        <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
        <h3 class="mt-4 text-lg font-semibold text-gray-900">No Benchmarks Yet</h3>
        <p class="mt-2 text-gray-600 max-w-md mx-auto">
            Run benchmarks using pytest to compare step implementations and view results here.
        </p>
        <div class="mt-6 bg-gray-50 rounded-lg p-4 text-left max-w-lg mx-auto">
            <p class="text-sm font-medium text-gray-700 mb-2">Example command:</p>
            <code class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">
                pipenv run pytest benchmarks/ -v
            </code>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Page size change
document.getElementById('per-page').addEventListener('change', function() {
    const params = new URLSearchParams(window.location.search);
    params.set('per_page', this.value);
    params.delete('page'); // Reset to page 1
    window.location.href = '/benchmarks?' + params.toString();
});

// Delete benchmark
async function deleteBenchmark(id, dbPath) {
    if (!confirm('Are you sure you want to delete this benchmark? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/benchmarks/${id}?db=${encodeURIComponent(dbPath)}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
            // Remove row from table
            const row = document.getElementById(`benchmark-row-${id}`);
            if (row) {
                row.remove();
            }
            // Reload if no more rows
            const tbody = document.querySelector('tbody');
            if (tbody && tbody.children.length === 0) {
                window.location.reload();
            }
        } else {
            alert('Failed to delete benchmark: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to delete benchmark: ' + error.message);
    }
}
</script>
{% endblock %}
